---
import Icon from "../atoms/Icon.astro";
import Image from "../atoms/Image.astro";
import type { CardHeaderIconFnType, CardHeaderImageFnType, ImageProps } from "./CardHeader.types";
import { getImagesForCardHeaderAndImageBrowser } from "./CardHeader.functions";
import { imageIndexCssVariableName } from "./CardHeader.consts";

interface Props {
    images?: ImageProps | ImageProps[];
    imageIsIcon?: boolean;
    imageHeight?: string;
    imageBorderRadius?: string | undefined;
    iconSize?: string;
    iconMargin?: string;
    iconFn?: (args: { icon: ImageProps, iconBorderRadius: string | undefined, iconMargin: string | undefined, iconSize: string }) => any;
    info?: string;
    type?: string;
}
const { images: images_, imageIsIcon, imageHeight = '15rem', imageBorderRadius, iconSize = '3rem', iconMargin = '1rem', iconFn, info, type } = Astro.props;

const images = getImagesForCardHeaderAndImageBrowser(images_);
let _mainImage: ImageProps | undefined;
const otherImages: ImageProps[] = [];
if (images) {
    for (let i = 0; i < (images?.length ?? 0); i++) {
        if (images[i].isMainImage && _mainImage == null) {
            _mainImage = images[i];
        } else {
            otherImages.push(images[i]);
        }
    }
}
const currentImage = _mainImage ?? (images == null ? null : (images.length > 0 ? images[0] : null));

const currentImageIndex = currentImage != null ? Math.max((images?.indexOf(currentImage) ?? 0), 0) : null;
const imagesTotal = images?.length;

const hasImagesMinimum = (minimum?: number) => images != null && images.length >= Math.max(minimum ?? 1, 1) && currentImage != null;
---

<div class="card-header-inner" style={!imageIsIcon && hasImagesMinimum() && currentImageIndex != null && `${imageIndexCssVariableName}: ${currentImageIndex};`}>
    { hasImagesMinimum() && currentImage != null &&
        <div class="image-preview">
            {
                (imageIsIcon
                    ? (Astro.slots.has('icon')
                        ? <Fragment set:html={await Astro.slots.render('icon', [{ icon: currentImage, iconBorderRadius: imageBorderRadius, iconMargin, iconSize }] satisfies Parameters<CardHeaderIconFnType>)} />
                        : <Icon url={currentImage.url} color={currentImage.color} imageSize={currentImage.imageSize} borderRadius={imageBorderRadius} containerMargin={iconMargin} size={iconSize} />
                    )
                    :   <div class="images-container">
                            {
                                images?.map(async image =>
                                    <div class="image-container-outer">
                                        {(Astro.slots.has('image')
                                            ? <Fragment set:html={await Astro.slots.render('image', [{ image, imageBorderRadius, imageHeight }] satisfies Parameters<CardHeaderImageFnType>)} />
                                            : <Image url={image.url} color={image.color} imageSize={image.imageSize} imageRepeat={image.imageRepeat} borderRadius={imageBorderRadius} height={imageHeight} />
                                        )}
                                    </div>
                                )
                            }
                        </div>
                )
            }
        </div>
    }
    <div class="controls">
        <div class="controls-top">
            {
                info != null && info.toString().trim().length > 0 &&
                    <Fragment>
                        <div role="button" class="info">
                            <slot name="infoButton" />
                        </div>
                        <div class="info-text display-none">
                            <slot name="infoText" />
                        </div>
                    </Fragment>
            }
            {
                hasImagesMinimum() && !imageIsIcon && Astro.slots.has('imageBrowser') &&
                    <Fragment>
                        <div role="button" class="image-browser-open">
                            <slot name="imageBrowserOpenButton" />
                        </div>
                        <div class="overlay overlay-image-browser" aria-hidden="true">
                            <slot name="imageBrowser" />
                        </div>
                    </Fragment>
            }
        </div>
        {
            hasImagesMinimum(2) && !imageIsIcon &&
                <div class="controls-middle">
                    <div role="button" class={`image-previous ${currentImageIndex != null && currentImageIndex <= 0 ? 'visually-hidden' : ''}`}>
                        <slot name="imagePreviousNavigatorButton" />
                    </div>
                    <div role="button" class={`image-next ${currentImageIndex != null && imagesTotal != null && currentImageIndex >= imagesTotal - 1 ? 'visually-hidden' : ''}`}>
                        <slot name="imageNextNavigatorButton" />
                    </div>
                </div>
        }
    </div>
</div>

<script>
    import '/src/scripts/card-header.ts';
</script>

<style lang="scss">
    .card-header-inner {
        position: relative;
        align-self: stretch;
    }

    .card-header-inner .image-preview {
        width: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .card-header-inner .image-preview + * {
        position: absolute;
        top: 0px;
        left: 0px;
        height: 100%;
        width: 100%;
        max-height: 100%;
        max-width: 100%;
        overflow: auto;
    }

    .card-header-inner .image-preview .images-container {
        display: flex;
        overflow: hidden;
        width: 100%;
        height: 100%;
        transition: 0.5s transform cubic-bezier(0.45, 0.05, 0.55, 0.95);
        transform: translateX(calc(var(--imageIndex, 0) * -100%));
    }

    .card-header-inner .image-preview .images-container .image-container-outer {
        flex: 0 0 100%; /* Each image takes full width of container */
        max-width: 100%;
        height: 100%;
    }

    .card-header-inner .controls {
        display: grid;

        > * {
            grid-area: 1 / 1 / 2 / 2;
        }
    }

    .card-header-inner .controls .controls-top {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-content: flex-start;
        justify-content: flex-end;
    }

    .card-header-inner .controls .controls-middle {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-content: center;
        justify-content: space-between;
    }

    .card-header-inner .controls .controls-middle * {
        opacity: 1;
        transition: 0.3s ease-in-out;
    }

    .overlay:not(.shown) {
        display: none;
    }
</style>