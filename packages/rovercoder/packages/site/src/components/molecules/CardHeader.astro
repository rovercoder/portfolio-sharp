---
import Icon from "../atoms/Icon.astro";
import Image from "../atoms/Image.astro";
import { prepareInlineScript } from "../../helpers/scripts";
import type { ImageProps } from "./CardHeader.types";

interface Props {
    image?: ImageProps | ImageProps[];
    imageIsIcon?: boolean;
    imageHeight?: string;
    imageBorderRadius?: string | undefined;
    iconSize?: string;
    iconMargin?: string;
    info?: string;
    type?: string;
}
const { image, imageIsIcon, imageHeight = '15rem', imageBorderRadius, iconSize = '3rem', iconMargin = '1rem', info, type } = Astro.props;

var images = (image == null || (Array.isArray(image) && image.filter(x => x != null).length === 0)) ? null : (Array.isArray(image) ? image.filter(x => x != null) : [image]);
var _mainImage;
const otherImages: ImageProps[] = [];
if (images) {
    for (var i = 0; i < (images?.length ?? 0); i++) {
        if (images[i].isMainImage && _mainImage == null) {
            _mainImage = images[i];
        } else {
            otherImages.push(images[i]);
        }
    }
}
var currentImage = _mainImage ?? (images == null ? null : (images.length > 0 ? images[0] : null));

var currentImageIndex = currentImage != null ? Math.max((images?.indexOf(currentImage) ?? 0), 0) : null;
var imagesTotal = images?.length;

const imageIndexCssVariableName = '--imageIndex';

const hasImagesMinimum = (minimum?: number) => images != null && images.length >= Math.max(minimum ?? 1, 1) && currentImage != null;
---

<div class="card-header-inner" style={!imageIsIcon && hasImagesMinimum() && currentImageIndex != null && `${imageIndexCssVariableName}: ${currentImageIndex};`}>
    { hasImagesMinimum() && currentImage != null &&
        <div class="image-preview">
            {
                (imageIsIcon
                    ? <Icon url={currentImage.url} color={currentImage.color} imageSize={currentImage.imageSize} borderRadius={imageBorderRadius} containerMargin={iconMargin} size={iconSize} />
                    :   <div class="images-container">
                            {
                                images?.map(image =>
                                    <div class="image-container-outer"><Image url={image.url} color={image.color} imageSize={image.imageSize} imageRepeat={image.imageRepeat} borderRadius={imageBorderRadius} height={imageHeight} /></div>
                                )
                            }
                        </div>
                )
            }
        </div>
    }
    <div class="controls">
        <div class="controls-top">
            {
                info != null && info.toString().trim().length > 0 &&
                    <Fragment>
                        <div role="button" class="info">
                            <slot name="infoButton" />
                        </div>
                        <div class="info-text display-none">
                            <slot name="infoText" />
                        </div>
                    </Fragment>
            }
            {
                hasImagesMinimum() && !imageIsIcon &&
                    <div role="button" class="image-browser-open">
                        <slot name="imageBrowserOpenButton" />
                    </div>
            }
        </div>
        {
            hasImagesMinimum(2) && !imageIsIcon &&
                <div class="controls-middle">
                    <div role="button" class={`image-previous ${currentImageIndex != null && currentImageIndex <= 0 ? 'visually-hidden' : ''}`}>
                        <slot name="imagePreviousNavigatorButton" />
                    </div>
                    <div role="button" class={`image-next ${currentImageIndex != null && imagesTotal != null && currentImageIndex >= imagesTotal - 1 ? 'visually-hidden' : ''}`}>
                        <slot name="imageNextNavigatorButton" />
                    </div>
                </div>
        }
    </div>
</div>

<script is:inline set:html={await prepareInlineScript("/src/scripts/.tsc-build/card-header.js")} />

<style>
    .card-header-inner {
        position: relative;
        align-self: stretch;
    }

    .card-header-inner .image-preview {
        width: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .card-header-inner .image-preview + * {
        position: absolute;
        top: 0px;
        left: 0px;
        height: 100%;
        width: 100%;
        max-height: 100%;
        max-width: 100%;
        overflow: auto;
    }

    .card-header-inner .image-preview .images-container {
        display: flex;
        overflow: hidden;
        width: 100%;
        height: 100%;
        transition: 0.5s transform cubic-bezier(0.45, 0.05, 0.55, 0.95);
        transform: translateX(calc(var(--imageIndex, 0) * -100%));
    }

    .card-header-inner .image-preview .images-container .image-container-outer {
        flex: 0 0 100%; /* Each image takes full width of container */
        max-width: 100%;
        height: 100%;
    }

    .card-header-inner .controls {
        display: grid;
    }

    .card-header-inner .controls > * {
        grid-area: 1 / 1 / 2 / 2;
    }

    .card-header-inner .controls .controls-top {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-content: flex-start;
        justify-content: flex-end;
    }

    .card-header-inner .controls .controls-middle {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-content: center;
        justify-content: space-between;
    }

    .card-header-inner .controls .controls-middle * {
        opacity: 1;
        transition: 0.3s ease-in-out;
    }
</style>